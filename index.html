<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baloch Tools - Sales Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .label {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .today {
            color: #27ae60;
        }

        .total {
            color: #3498db;
        }

        .profit {
            color: #e74c3c;
        }

        .items {
            color: #f39c12;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
            font-size: 1.5em;
        }

        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        th {
            background: #34495e;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .user-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .user-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border-left: 5px solid #3498db;
        }

        .user-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .user-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px 0;
        }

        .user-stat:last-child {
            margin-bottom: 0;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
            font-size: 1.2em;
        }

        .error {
            text-align: center;
            padding: 50px;
            color: #e74c3c;
            font-size: 1.2em;
        }

        .refresh-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s ease;
        }

        .refresh-btn:hover {
            background: #2980b9;
        }

        .last-updated {
            text-align: center;
            color: #7f8c8d;
            font-size: 0.9em;
            margin-top: 20px;
            padding: 15px;
            background: #ecf0f1;
            border-radius: 5px;
        }

        .currency {
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
                padding: 20px;
            }

            .content {
                padding: 20px;
            }

            .user-stats {
                grid-template-columns: 1fr;
            }

            .controls-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .date-filters {
                flex-direction: column;
                width: 100%;
            }

            .filter-group {
                width: 100%;
            }

            .filter-group input {
                width: 100%;
            }
        }

        .controls-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 20px;
            flex-wrap: wrap;
        }

        .date-filters {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 0.9em;
            color: #7f8c8d;
            font-weight: 600;
        }

        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            font-family: inherit;
            color: #2c3e50;
        }

        .filter-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
            height: 38px;
        }

        .filter-btn:hover {
            background: #2ecc71;
        }

        .reset-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
            height: 38px;
        }

        .reset-btn:hover {
            background: #7f8c8d;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üîß BALOCH TOOLS & WELDING MATERIALS</h1>
            <p>Sales Dashboard & Analytics</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Today's Sales</h3>
                <div class="value today" id="todaySales">PKR 0</div>
                <div class="label">Current Day Revenue</div>
            </div>
            <div class="stat-card">
                <h3>Today's Profit</h3>
                <div class="value profit" id="todayProfit">PKR 0</div>
                <div class="label">Current Day Profit</div>
            </div>
            <div class="stat-card">
                <h3>Total Sales</h3>
                <div class="value total" id="totalSales">PKR 0</div>
                <div class="label" id="totalSalesLabel">Last 7 Days Revenue</div>
            </div>
            <div class="stat-card">
                <h3>Total Profit</h3>
                <div class="value profit" id="totalProfit">PKR 0</div>
                <div class="label" id="totalProfitLabel">Last 7 Days Profit</div>
            </div>
            <div class="stat-card">
                <h3>Items Sold</h3>
                <div class="value items" id="todayItems">0</div>
                <div class="label" id="itemsSoldLabel">Products Sold (Period)</div>
            </div>
        </div>

        <div class="content">
            <div class="controls-bar">
                <div class="date-filters">
                    <div class="filter-group">
                        <label>Start Date</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="filter-group">
                        <label>End Date</label>
                        <input type="date" id="endDate">
                    </div>
                    <button class="filter-btn" onclick="applyDateFilter()">Filter</button>
                    <button class="reset-btn" onclick="resetFilters()">Reset</button>
                </div>
                <button class="refresh-btn" onclick="loadData()">üîÑ Refresh Data</button>
            </div>

            <div id="loadingMessage" class="loading">
                Loading sales data...
            </div>

            <div id="errorMessage" class="error" style="display: none;">
                Failed to load data. Please check your internet connection and try again.
            </div>

            <div id="mainContent" style="display: none;">
                <div class="section">
                    <h2>üë• Sales by User</h2>
                    <div class="user-stats" id="userStats">
                        <!-- User statistics will be populated here -->
                    </div>
                </div>

                <div class="section">
                    <h2>üìä Recent Sales Records</h2>
                    <div class="table-container">
                        <table id="salesTable">
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th>Unit Price</th>
                                    <th>Total Price</th>
                                    <th>Profit</th>
                                    <th>Sold By</th>
                                </tr>
                            </thead>
                            <tbody id="salesTableBody">
                                <!-- Sales records will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="section">
                    <h2>üèÜ Top Products</h2>
                    <div class="table-container">
                        <table id="productsTable">
                            <thead>
                                <tr>
                                    <th>Product Name</th>
                                    <th>Total Sold</th>
                                    <th>Total Revenue</th>
                                    <th>Total Profit</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <!-- Top products will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="last-updated" id="lastUpdated">
                Last updated: Never
            </div>
        </div>
    </div>

    <script>
        // Configuration - Update this with your Gist URL
        const GIST_URL = 'https://gist.githubusercontent.com/BalochTools123/5efc12ef2de66de1b52aeb838c92c158/raw/sales_data.json';

        // You can also use a local file for testing
        // const GIST_URL = './sales_data.json';

        let salesData = null;
        let originalSalesRecords = [];

        function initDateFilters() {
            const today = new Date();
            const lastWeek = new Date(today);
            lastWeek.setDate(today.getDate() - 7);

            document.getElementById('endDate').valueAsDate = today;
            document.getElementById('startDate').valueAsDate = lastWeek;
        }

        function resetFilters() {
            initDateFilters();
            applyDateFilter();
        }

        function applyDateFilter() {
            if (!originalSalesRecords.length) return;

            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            // Set end date to end of day
            endDate.setHours(23, 59, 59, 999);
            startDate.setHours(0, 0, 0, 0);

            const filteredRecords = originalSalesRecords.filter(record => {
                const recordDate = new Date(record.sale_date);
                return recordDate >= startDate && recordDate <= endDate;
            });

            // Calculate statistics for filtered data
            const stats = calculateStats(filteredRecords);

            // Update UI
            updateStatistics(stats, true); // true indicates filtered mode
            updateSalesTable(filteredRecords);
            updateTopProductsFromRecords(filteredRecords);
            updateUserStatsFromRecords(filteredRecords);
        }

        function updateUserStatsFromRecords(records) {
            const userStats = {};

            records.forEach(record => {
                const user = record.sold_by || 'Unknown';
                if (!userStats[user]) {
                    userStats[user] = {
                        total_sales: 0,
                        total_profit: 0,
                        items_sold: 0,
                        today_sales: 0,
                        today_profit: 0
                    };
                }
                userStats[user].total_sales += record.total_price;
                userStats[user].total_profit += record.profit;
                userStats[user].items_sold += record.quantity;
            });

            // Fill in "Today" stats from original data for context
            if (salesData && salesData.statistics && salesData.statistics.user_stats) {
                for (const [user, stats] of Object.entries(userStats)) {
                    if (salesData.statistics.user_stats[user]) {
                        stats.today_sales = salesData.statistics.user_stats[user].today_sales || 0;
                        stats.today_profit = salesData.statistics.user_stats[user].today_profit || 0;
                    }
                }
            }

            updateUserStats(userStats, true);
        }

        function calculateStats(records) {
            let totalSales = 0;
            let totalProfit = 0;
            let itemsSold = 0;

            records.forEach(record => {
                totalSales += record.total_price;
                totalProfit += record.profit;
                itemsSold += record.quantity;
            });

            // For "Today's" stats, we still go back to the original full dataset or handle it separately.
            // However, the user request specifically asked for "Total revenue and profit also updates according to the filter".
            // So we will pass these calculated totals to updateStatistics.

            return {
                total_sales: totalSales,
                total_profit: totalProfit,
                total_items_sold: itemsSold
            };
        }

        function updateTopProductsFromRecords(records) {
            const productStats = {};

            records.forEach(record => {
                const name = record.product_name;
                if (!productStats[name]) {
                    productStats[name] = {
                        total_quantity: 0,
                        total_sales: 0,
                        total_profit: 0
                    };
                }
                productStats[name].total_quantity += record.quantity;
                productStats[name].total_sales += record.total_price;
                productStats[name].total_profit += record.profit;
            });

            updateTopProducts(productStats);
        }

        function formatCurrency(amount) {
            return `PKR ${parseFloat(amount).toLocaleString('en-PK', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('en-PK', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showLoading() {
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('mainContent').style.display = 'none';
        }

        function showError() {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
        }

        function showContent() {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        function updateStatistics(stats, isFiltered = false) {
            // "Today" stats should always come from the main salesData statistics object to remain accurate to "Today" regardless of filter,
            // UNLESS the user wants "Today" to verify logic. 
            // But typically "Today" cards are static dashboard elements. 
            // The "Total" cards will now reflect the Filtered Range.

            if (salesData && salesData.statistics) {
                document.getElementById('todaySales').textContent = formatCurrency(salesData.statistics.today_sales || 0);
                document.getElementById('todayProfit').textContent = formatCurrency(salesData.statistics.today_profit || 0);
                document.getElementById('todayItems').textContent = (salesData.statistics.today_items_sold || 0).toLocaleString();
            }

            document.getElementById('totalSales').textContent = formatCurrency(stats.total_sales || 0);

            // Update Total Profit
            if (document.getElementById('totalProfit')) {
                document.getElementById('totalProfit').textContent = formatCurrency(stats.total_profit || 0);
            }

            // Update Items Sold (Period)
            if (document.getElementById('todayItems')) {
                // We use todayItems ID for item count to reuse existing element, but logic is now period based
                document.getElementById('todayItems').textContent = (stats.total_items_sold || 0).toLocaleString();
            }

            // We need to update the card labels to reflect that it's filtered
            if (isFiltered) {
                document.getElementById('totalSalesLabel').textContent = "Revenue (Selected Period)";
                if (document.getElementById('totalProfitLabel')) {
                    document.getElementById('totalProfitLabel').textContent = "Profit (Selected Period)";
                }
                if (document.getElementById('itemsSoldLabel')) {
                    document.getElementById('itemsSoldLabel').textContent = "Products Sold (Selected Period)";
                }
            } else {
                document.getElementById('totalSalesLabel').textContent = "All Time Revenue";
                if (document.getElementById('totalProfitLabel')) {
                    document.getElementById('totalProfitLabel').textContent = "All Time Profit";
                }
                if (document.getElementById('itemsSoldLabel')) {
                    document.getElementById('itemsSoldLabel').textContent = "Products Sold (All Time)";
                }
            }
        }

        function updateUserStats(userStats, isFiltered = false) {
            const container = document.getElementById('userStats');
            container.innerHTML = '';

            const totalSalesLabel = isFiltered ? "Sales (Period):" : "Total Sales:";
            const totalProfitLabel = isFiltered ? "Profit (Period):" : "Total Profit:";
            const itemsSoldLabel = isFiltered ? "Items (Period):" : "Items Sold:";

            for (const [username, stats] of Object.entries(userStats)) {
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                userCard.innerHTML = `
                    <h3>üë§ ${username}</h3>
                    <div class="user-stat">
                        <span>Today's Sales:</span>
                        <span class="currency">${formatCurrency(stats.today_sales || 0)}</span>
                    </div>
                    <div class="user-stat">
                        <span>Today's Profit:</span>
                        <span class="currency">${formatCurrency(stats.today_profit || 0)}</span>
                    </div>
                    <div class="user-stat">
                        <span>${totalSalesLabel}</span>
                        <span class="currency">${formatCurrency(stats.total_sales || 0)}</span>
                    </div>
                    <div class="user-stat">
                        <span>${totalProfitLabel}</span>
                        <span class="currency">${formatCurrency(stats.total_profit || 0)}</span>
                    </div>
                    <div class="user-stat">
                        <span>${itemsSoldLabel}</span>
                        <span>${(stats.items_sold || 0).toLocaleString()}</span>
                    </div>
                `;
                container.appendChild(userCard);
            }
        }

        function updateSalesTable(salesRecords) {
            const tbody = document.getElementById('salesTableBody');
            tbody.innerHTML = '';

            // If we are filtering, we typically want to show all matching records, 
            // but for performance we might still want to limit if thousands.
            // For now, let's show up to 500 if filtered, or just all of them.
            // The user said "show last week's all records".

            salesRecords.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(record.sale_date)}</td>
                    <td>${record.product_name}</td>
                    <td>${record.quantity}</td>
                    <td>${formatCurrency(record.unit_price)}</td>
                    <td>${formatCurrency(record.total_price)}</td>
                    <td>${formatCurrency(record.profit)}</td>
                    <td>${record.sold_by}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateTopProducts(topProducts) {
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '';

            // Show only top 20 products
            const topProductsArray = Object.entries(topProducts).slice(0, 20);

            topProductsArray.forEach(([productName, stats]) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${productName}</td>
                    <td>${stats.total_quantity}</td>
                    <td>${formatCurrency(stats.total_sales)}</td>
                    <td>${formatCurrency(stats.total_profit)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateLastUpdated(timestamp) {
            document.getElementById('lastUpdated').textContent = `Last updated: ${formatDate(timestamp)}`;
        }

        async function loadData() {
            showLoading();

            try {
                // Add cache busting parameter to ensure fresh data
                const url = GIST_URL + '?t=' + new Date().getTime();
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                salesData = await response.json();
                originalSalesRecords = salesData.sales_records || [];

                // Initialize filters if first load
                if (!document.getElementById('startDate').value) {
                    initDateFilters();
                }

                // Apply logic
                applyDateFilter();

                // updateUserStats removed from here as it is called inside applyDateFilter
                updateLastUpdated(salesData.statistics.last_updated || new Date().toISOString());

                showContent();

            } catch (error) {
                console.error('Error loading data:', error);
                showError();
            }
        }

        // Auto-refresh every 2 minutes
        function startAutoRefresh() {
            setInterval(loadData, 2 * 60 * 1000); // 2 minutes
        }

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function () {
            loadData();
            startAutoRefresh();
        });

        // Handle visibility change to refresh when tab becomes active
        document.addEventListener('visibilitychange', function () {
            if (!document.hidden) {
                loadData();
            }
        });
    </script>
</body>

</html>
